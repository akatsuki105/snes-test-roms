lorom : header

org $008000 : fill $020000

org $00ffc0
  db 'bsnes sprite test rom'
  db $30   ;lorom ($31 = hirom)
  db $02   ;rom+save ram
  db $08   ;2mbit rom
  db $03   ;64kb sram
  db $00   ;japan
  db $00   ;no developer
  db $01   ;version 1.1
  dw $0000 ;inverse checksum
  dw $ffff ;checksum

  dw $ffff,$ffff,$ffff
  dw $0000 ;brk
  dw $ffff
  dw $0000 ;nmi
  dw $ffff,$ffff,$ffff,$ffff
  dw $0000 ;cop
  dw $ffff,$ffff,$ffff
  dw $8000 ;reset
  dw $ffff

org $008000
  clc : xce

  sep #$20 : rep #$10
  ldx #$01ff : txs
  jsr init_snes

  rep #$10
  lda #$8f   : sta $2100 ;disable screen
  lda.b #%01100000 : sta $2101 ;oam size: 8x8; oam tiledata: $0000
  lda #$01   : sta $2105 ;mode1
  lda #$80   : sta $2115 ;inc after $2119 write
  lda #$10   : sta $212c ;enable oam

  lda #$00   : sta $2121
  ldx #$0000
- lda palette1,x : sta $2122 : inx
  cpx.w #end_palette1-palette1 : bcc -

  lda #$80   : sta $2121
  ldx #$0000
- lda palette2,x : sta $2122 : inx
  cpx.w #end_palette2-palette2 : bcc -

  ldx #$0000 : stx $2116
  lda #$01   : sta $4300
  lda #$18   : sta $4301
  lda.b #tiledata     : sta $4302
  lda.b #tiledata>>8  : sta $4303
  lda.b #tiledata>>16 : sta $4304
  ldx.w #end_tiledata-tiledata : stx $4305
  lda #$01   : sta $420b

  lda #$00 : sta $2102
  lda #$00 : sta $2103

  ldx #$0000
- txa : sta $2104
  lda #$00 : sta $2104
  lda #$02 : sta $2104
  lda #$00 : sta $2104
  inx : cpx.w #128 : bcc -

  lda.b #%00000000 : sta $2133

  lda #$0f : sta $2100

- bra -

  lda #$00 : sta $00
.loop
- lda $4210 : bpl -
  lda #$00 : sta $2102
  lda #$00 : sta $2103

  lda $00  : sta $2104 : inc $00
  lda #$f8 : sta $2104
  lda #$02 : sta $2104
  lda #$00 : sta $2104
  bra .loop

init_snes() {
  lda #$8f : sta $2100
  lda #$00
  ldx #$2101
- sta $0000,x : inx : cpx #$210d : bcc -
- sta $0000,x : sta $0000,x : inx : cpx #$2115 : bcc -
  ldx #$2116
- sta $0000,x : inx : cpx #$211b : bcc -
- sta $0000,x : sta $0000,x : inx : cpx #$2121 : bcc -
- sta $0000,x : inx : cpx #$2134 : bcc -
  ldx #$4202
- sta $0000,x : inx : cpx #$420e : bcc -

  lda #$80 : sta $2115 ;increment on $2119 write
  lda #$01 : sta $4200 ;enable joypad, not nmi
  lda #$81 : sta $4212 ;bit7=in vblank, bit0=joypad ready

  ldx #$0000 : stx $2116
  lda #$00
 .loop {
    sta $2118
    sta $2119
    inx : inx : bne .loop
  }

  ldx #$000 : stx $2102
  lda #$00
.loop2 {
    sta $2104
    sta $2104
    inx : inx : cpx.w #544 : bcc .loop2
  }

  rts
}

tiledata:
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000

  dw $0078,$00cc,$00cc,$00fc,$00cc,$00cc,$00cc,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $00f8,$00cc,$00cc,$00f8,$00cc,$00cc,$00f8,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000

  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000

  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000

  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000

  dw $0078,$00cc,$00c0,$00c0,$00c0,$00cc,$0078,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
  dw $00f8,$00cc,$00cc,$00cc,$00cc,$00cc,$00f8,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000

end_tiledata:

palette1:
  dw $7c00,$7fff,$001f,$001f,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
end_palette1:

palette2:
  dw $0000,$001f,$0000,$0000,$0000,$0000,$0000,$0000
  dw $0000,$0000,$0000,$0000,$0000,$0000,$0000,$0000
end_palette2:
